<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Math+it - AI Math Solver</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #fff;
            font-size: 1.2rem;
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .search-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-container h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.5rem;
            font-weight: 600;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 15px 60px 15px 20px;
            font-size: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input[type="text"]:focus, input[type="file"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .upload-icon {
            position: absolute;
            right: 15px;
            top: 40%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .upload-icon:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
            color: #475569;
        }

        .upload-icon.has-image {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .upload-icon svg {
            width: 18px;
            height: 18px;
        }

        .hidden-file-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        button {
            width: 100%;
            padding: 15px 30px;
            font-size: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .graph {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #graph {
            width: 100%;
            min-height: 350px;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .ai-service {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .ai-service:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .ai-service h3 {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-service .icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }

        .gemini {
            background: linear-gradient(135deg, #4285f4, #34a853);
        }

        .deepseek {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }

        .wolfram {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
        }

        .llama {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .symbolab {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .stackexchange {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .answer-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
            border-left: 4px solid #e2e8f0;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
        }

        .loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            color: #e53e3e;
            background: #fed7d7;
            border-left-color: #e53e3e;
        }

        .success {
            border-left-color: #38a169;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .results-container {
                grid-template-columns: 1fr;
            }
        }

        /* Sample questions */
        .sample-questions {
            margin-top: 20px;
        }

        .sample-questions h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sample-question {
            display: block;
            width: 100%;
            text-align: left;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 8px;
            color: #475569;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .sample-question:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
            transform: translateX(5px);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Math+it</h1>
            <p>AI-Powered Mathematics Solver with Multiple Expert Systems</p>
        </div>

        <div class="left-panel">
            <div class="search-container">
                <h2>Ask Your Math Question</h2>
                <form id="mathForm" method="POST" enctype="multipart/form-data">
                    <div class="input-container">
                        <input type="text" id="question" name="question" placeholder="Type your math question here..."
                            required />
                        <div class="upload-icon" id="uploadIcon" title="Upload math image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                            </svg>
                        </div>
                        <input type="file" id="image" name="image" accept="image/*" class="hidden-file-input" />
                    </div>
                    
                    <button type="submit">Solve with AI</button>
                </form>

                <div class="sample-questions">
                    <h4>Try these examples:</h4>
                    <button type="button" class="sample-question" onclick="setQuestion('Solve x² + 5x + 6 = 0')">
                        Solve x² + 5x + 6 = 0
                    </button>
                    <button type="button" class="sample-question"
                        onclick="setQuestion('Find the derivative of sin(x) * cos(x)')">
                        Find the derivative of sin(x) * cos(x)
                    </button>
                    <button type="button" class="sample-question"
                        onclick="setQuestion('Calculate the integral of x² from 0 to 5')">
                        Calculate the integral of x² from 0 to 5
                    </button>
                </div>
            </div>

            <div class="graph">
                <div id='graph' style="width: 100%; height: 100%;">
                    {{plot|safe}}
                </div>
            </div>
        </div>

        <div class="results-container">
            <div class="ai-service">
                <h3><span class="icon gemini">G</span>Gemini</h3>
                <div id="answer1" class="answer-content">Ready to solve your math problems...</div>
            </div>

            <div class="ai-service">
                <h3><span class="icon deepseek">D</span>DeepSeek</h3>
                <div id="answer2" class="answer-content">Ready to solve your math problems...</div>
            </div>

            <div class="ai-service">
                <h3><span class="icon wolfram">W</span>Wolfram</h3>
                <div id="answer3" class="answer-content">Ready to solve your math problems...</div>
            </div>

            <div class="ai-service">
                <h3><span class="icon llama">L</span>Llama</h3>
                <div id="answer4" class="answer-content">Ready to solve your math problems...</div>
            </div>

            <div class="ai-service">
                <h3><span class="icon symbolab">S</span>Symbolab</h3>
                <div id="answer5" class="answer-content">Ready to solve your math problems...</div>
            </div>

            <div class="ai-service">
                <h3><span class="icon stackexchange">SE</span>StackExchange</h3>
                <div id="answer6" class="answer-content">Ready to solve your math problems...</div>
            </div>
        </div>
    </div>

    <script>
        function getCSRFToken() {
            return document.cookie.split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }
        
        function setQuestion(question) {
            document.getElementById("question").value = question;
        }
        
        function setLoading(element, serviceName) {
            element.innerHTML = `<div class="loading">Solving with ${serviceName}...</div>`;
            element.className = 'answer-content';
        }
        
        function setSuccess(element, content) {
            element.innerHTML = content;
            element.className = 'answer-content success';
        }
        
        function setError(element, serviceName) {
            element.innerHTML = `Error with ${serviceName}`;
            element.className = 'answer-content error';
        }
        
        // Handle upload icon click
        document.getElementById('uploadIcon').addEventListener('click', function() {
            document.getElementById('image').click();
        });
        
        // Handle file selection
        document.getElementById('image').addEventListener('change', function(e) {
            const uploadIcon = document.getElementById('uploadIcon');
            const file = e.target.files[0];
            
            if (file) {
                uploadIcon.classList.add('has-image');
                uploadIcon.title = `Image selected: ${file.name}`;
                uploadIcon.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                `;
            } else {
                uploadIcon.classList.remove('has-image');
                uploadIcon.title = 'Upload math image';
                uploadIcon.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="9" cy="9" r="2"/>
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                    </svg>
                `;
            }
        });
        
        // Update graph
        async function updateGraph(question) {
            const headers = {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCSRFToken()
            };
            const body = new URLSearchParams({ question });
        
            try {
                const response = await fetch('/update_graph', {
                    method: "POST",
                    headers: headers,
                    body: body
                });
        
                const data = await response.json();
        
                if (response.ok && data.plot) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.plot;
        
                    const graphDiv = document.getElementById('graph');
                    graphDiv.innerHTML = '';
        
                    while (tempDiv.firstChild) {
                        graphDiv.appendChild(tempDiv.firstChild);
                    }
        
                    const scripts = graphDiv.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.type = script.type || 'text/javascript';
        
                        if (script.src) {
                            newScript.src = script.src;
                            newScript.onload = () => {
                                executeInlineScripts();
                            };
                            document.head.appendChild(newScript);
                        } else if (script.textContent.trim()) {
                            try {
                                eval(script.textContent);
                            } catch (e) {
                                console.error('Error executing script:', e);
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating graph:', error);
            }
        }
        
        function executeInlineScripts() {
            const scripts = document.getElementById('graph').querySelectorAll('script');
            scripts.forEach(script => {
                if (!script.src && script.textContent.trim()) {
                    try {
                        eval(script.textContent);
                    } catch (e) {
                        console.error('Error executing inline script:', e);
                    }
                }
            });
        }
        
        // Main form submission handler
        document.getElementById("mathForm").addEventListener("submit", async function (event) {
            event.preventDefault();
        
            const question = document.getElementById("question").value.trim();
            const imageFile = document.getElementById("image").files[0];
        
            const answerBoxes = [
                { element: document.getElementById("answer1"), name: "Gemini", endpoint: "/send_gemeni" },
                { element: document.getElementById("answer2"), name: "DeepSeek", endpoint: "/send_deepseek" },
                { element: document.getElementById("answer3"), name: "Wolfram", endpoint: "/send_welfram" },
                { element: document.getElementById("answer4"), name: "Llama", endpoint: "/send_llama" },
                { element: document.getElementById("answer5"), name: "Symbolab", endpoint: "/send_sympolab" },
                { element: document.getElementById("answer6"), name: "StackExchange", endpoint: "/send_stackexchange" }
            ];
        
            if (!question && !imageFile) {
                answerBoxes.forEach(box => {
                    box.element.innerHTML = "Please enter a math question or upload an image.";
                    box.element.className = 'answer-content error';
                });
                return;
            }
        
            // Set all to loading state
            answerBoxes.forEach(box => setLoading(box.element, box.name));
        
            // ALWAYS send to image2latyx endpoint - regardless of whether there's an image or not
            const formDataImage = new FormData();
            formDataImage.append('question', question);
            // Only append image if one exists
            if (imageFile) {
                formDataImage.append('image', imageFile);
            }
            
            try {
                const resImg = await fetch('/image2latyx', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    body: formDataImage
                });
                if (!resImg.ok) {
                    console.warn('Image to LaTeX conversion request failed.');
                }
            } catch (err) {
                console.error('Error sending to image2latyx:', err);
            }
        
            // Update graph
            await updateGraph(question);
        
            // Process all AI services
            const promises = answerBoxes.map(async (box) => {
                try {
                    const formData = new FormData();
                    formData.append('question', question);
                    if (imageFile) {
                        formData.append('image', imageFile);
                    }
        
                    const response = await fetch(box.endpoint, {
                        method: "POST",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        body: formData
                    });
        
                    const data = await response.json();
        
                    if (!response.ok) {
                        throw new Error(`${box.name} error`);
                    }
        
                    setSuccess(box.element, data.response || `No answer received from ${box.name}`);
        
                    if (window.MathJax) {
                        setTimeout(() => MathJax.typesetPromise([box.element]), 100);
                    }
        
                } catch (error) {
                    console.error(`Error with ${box.name}:`, error);
                    setError(box.element, box.name);
                }
            });
        
            await Promise.allSettled(promises);
        });
    </script>
        
</body>

</html>